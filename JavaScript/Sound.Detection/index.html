<html>
<head>
  <style type="text/css">
    body {
      font-family: "Arial Black", Gadget, sans-serif;
      font-size: 14px;
    }
    canvas {
      display: block;
    }
    section {
      width: 200px;
    }
    section > * {
      display: block;
      margin-bottom: 8px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
  </style>
  <script>

    function getUserAudio(onAudioCallback, onErrorCallback) {
      var FFT_SIZE = 512;
      var context = new AudioContext();

      function connectToStream(stream) {
        var mediaStreamSource = context.createMediaStreamSource(stream);

        var processorNode = context.createScriptProcessor();
        processorNode.connect(context.destination);
        processorNode.onaudioprocess = function() {
          onAudioCallback(analyzer);
        };

        var analyzer = context.createAnalyser();
        analyzer.fftSize = FFT_SIZE;
        mediaStreamSource.connect(analyzer);
        analyzer.connect(processorNode);
        analyzer.connect(context.destination);
      }

      navigator.mediaDevices.getUserMedia({
        audio: true
      }).then(connectToStream).catch(onErrorCallback);
    }

    function sensorStart() {
      getUserAudio(function(analyzer) {
        var frequencyValues = new Uint8Array(analyzer.frequencyBinCount);
        analyzer.getByteFrequencyData(frequencyValues);

        var averageFrequencyValue = Array.from(frequencyValues).reduce(function(acc, value) {
          return acc + value / frequencyValues.length;
        }, 0) / frequencyValues.length;

        var volumeValue = Math.floor(averageFrequencyValue * 100);
        display(volumeValue);
      }, function error(e) {
        var errorMessageNode = document.createTextNode(
          'Error while trying to listen to the microphone...' + JSON.stringify(e)
        );
        document.body.appendChild(errorMessageNode);
      });
    }

    function display(volumeValue) {
      setTimeout(function() {
        drawVolumeBar(volumeValue)
      });
    }

    var canvasContainer;
    var renderContext;

    function initRenderContext() {
      canvasContainer = document.getElementById('sensorCanvas');
      renderContext = canvasContainer.getContext('2d');
    }

    function drawVolumeBar(volumeValue) {
      renderContext.fillStyle = '#fff';
      renderContext.fillRect(0, 0, 60, 200);
      renderContext.fillStyle = '#90949c';
      renderContext.fillRect(0, 200 - volumeValue * 2, 60, 200);
      renderContext.fillStyle = 'black';
      renderContext.font = '12px serif';
      renderContext.fillText(volumeValue.toFixed(0) + '%', 20, 180);
      renderContext.rect(0, 0, 60, 200);
      renderContext.stroke();
    }

    window.addEventListener('load', function(event) {
      initRenderContext();
      sensorStart();
    });
  </script>
</head>
<body>
  <section>
    <span>Volume</span>
    <canvas id="sensorCanvas" width="60" height="200"></canvas>
  </section>
</body>
</html>