<html>
<head>
  <style type="text/css">
    div {
      font-size: 2em;
    }
  </style>
  <script src="bower_components/highcharts/highcharts.js"></script>
  <script>

    function getUserAudio(onAudioCallback, onErrorCallback) {
      var FFT_SIZE = 512;
      var context = new AudioContext();

      function connectToStream(stream) {
        var mediaStreamSource = context.createMediaStreamSource(stream);

        var processorNode = context.createScriptProcessor();
        processorNode.connect(context.destination);
        processorNode.onaudioprocess = function() {
          onAudioCallback(analyzer);
        };

        var analyzer = context.createAnalyser();
        analyzer.fftSize = FFT_SIZE;
        mediaStreamSource.connect(analyzer);
        analyzer.connect(processorNode);
        analyzer.connect(context.destination);
      }

      navigator.mediaDevices.getUserMedia({
        audio: true
      }).then(connectToStream).catch(onErrorCallback);
    }

    function sensorStart() {
      getUserAudio(function(analyzer) {
        var frequencyValues = new Uint8Array(analyzer.frequencyBinCount);
        analyzer.getByteFrequencyData(frequencyValues);

        var averageFrequencyValue = Array.from(frequencyValues).reduce(function(acc, value) {
          return acc + value / frequencyValues.length;
        }, 0) / frequencyValues.length;

        var volumeValue = Math.floor(averageFrequencyValue * 100);
        display(volumeValue);
      }, function error(e) {
        var errorMessageNode = document.createTextNode(
          'Error while trying to listen to the microphone...' + JSON.stringify(e)
        );
        document.body.appendChild(errorMessageNode);
      });
    }

    function display(volumeValue) {
      setTimeout(function() {
        drawVolumeBar(volumeValue)
      });
    }

    var canvasContainer;
    var renderContext;

    function initRenderContext() {
      canvasContainer = document.getElementById('sensorCanvas');
      renderContext = canvasContainer.getContext('2d');
    }

    function drawVolumeBar(volumeValue) {
      renderContext.fillStyle = '#fff';
      renderContext.fillRect(0, 0, 20, 100);
      renderContext.fillStyle = '#777';
      renderContext.fillRect(0, 100 - volumeValue, 20, 100);
      renderContext.rect(0, 0, 20, 100);
      renderContext.stroke();
    }

    window.addEventListener('load', function(event) {
      initRenderContext();
      sensorStart();
    });
  </script>
</head>
<body>
  <canvas id="sensorCanvas" width="20" height="100"></canvas>
</body>
</html>